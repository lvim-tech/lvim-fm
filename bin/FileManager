#!/bin/bash
builtin cd "$1" || return

mkdir -p /tmp/lvim-file-manager
chmod 777 /tmp/lvim-file-manager

echo "$PWD" >/tmp/lvim-file-manager/base-directory

if [[ -f /tmp/lvim-file-manager/pwd ]]; then
	builtin cd "$(cat /tmp/lvim-file-manager/pwd)" || return
fi

if [[ ! -f /tmp/lvim-file-manager/action ]]; then
	echo "menu" >/tmp/lvim-file-manager/action
fi

function print_fzf_menu {
	echo "󰙅 EXPLORER"
	echo "󱋣 SEARCH DIRECTORIES AND FILES"
	echo "󰉋 SEARCH DIRECTORIES"
	echo "󰈔 SEARCH FILES"
	echo "󰈙 SEARCH IN FILES"
}

function print_fzf_header {
	echo " ."
	[[ $PWD = "/" ]] && echo "/" || echo " .."
}

function explorer {
	exa \
		$show_hidden_files \
		$long_info \
		--group \
		--icons \
		--classify \
		--git-ignore \
		--ignore-glob '.cache|.git|.vendor|node_modules|buffers' \
		--group-directories-first \
		--colour=always \
		--level 1 "${1:-$PWD}" | sed "s/\*$//g"
}

function search_directories_and_files {
	if [ -f /tmp/lvim-file-manager/hidden-files ]; then
		fd -H --color always
	else
		fd --color always
	fi
}

function search_directories {
	if [ -f /tmp/lvim-file-manager/hidden-files ]; then
		fd -H --color always --type d
	else
		fd --color always --type d -E
	fi
}

function search_files {
	if [ -f /tmp/lvim-file-manager/hidden-files ]; then
		fd -H --color always --type f
	else
		fd --color always --type f
	fi
}

function search_in_files {
	if [[ -f /tmp/lvim-file-manager/hidden-files ]]; then
		rg --hidden --follow --color=always -n ${list_files:+-l} "$1"
	else
		rg --follow --color=always -n ${list_files:+-l} "$1"
	fi
}

function get_list_for_fzf {
	if [[ $action == "menu" ]]; then
		print_fzf_menu "$1"
	elif [[ $action == "explorer" ]]; then
		print_fzf_header "$1"
		explorer "$1"
	elif [[ $action == "search-directories-and-files" ]]; then
		print_fzf_header "$1"
		search_directories_and_files "$1"
	elif [[ $action == "search-directories" ]]; then
		print_fzf_header "$1"
		search_directories "$1"
	elif [[ $action == "search-files" ]]; then
		print_fzf_header "$1"
		search_files "$1"
	elif [[ $action == "search-in-files" ]]; then
		print_fzf_header "$1"
		search_in_files "$1"
	fi
}

function strip_output {
	awk -F':' '{print $1}' |
		rev |
		cut -f1 -d ' ' |
		rev |
		sed \
			-e 's/\[[0-9];[0-9][0-9]m//g' \
			-e 's/\[[0-9];[0-9];[0-9][0-9]m//g' \
			-e 's/\[0m//g' \
			-e 's/ //g'
}

function get_column_to_search {
	# local nth=1
	if [[ $action == "explorer" ]] && [[ -f /tmp/lvim-file-manager/long-info ]]; then
		nth='8..-1'
	elif [[ $action == "explorer" ]] && [[ ! -f /tmp/lvim-file-manager/long-info ]]; then
		nth='2..-1'
	else
		nth=".."
	fi
	echo -n $nth
}

function post_action {
	is_break=false
	directories=()
	files=()
	for result in $selected; do
		if [[ $is_explorer ]]; then
			result=$PWD/$result
		fi
		if [[ -d $result ]]; then
			directories+=("$result")
		elif [[ -f $result ]]; then
			files+=("$result")
		fi
	done
	if [[ ${#directories[@]} -gt 0 ]]; then
		builtin cd "${directories[-1]}" || return
	fi
	if [[ ${#files[@]} != 0 ]]; then
		for i in "${files[@]}"; do
			echo "$i" >>/tmp/lvim-shell
		done
		is_break=true
	fi
	is_explorer=false
}

function post_action_search {
	is_break=false
	files=()
	clean_selected=$(echo "$selected" | sed "s/:.*//g")
	for result in $clean_selected; do
		files+=("$result")
	done
	mapfile -t files < <(echo "${files[@]}" | awk 'BEGIN{RS=" ";} !a[$1]++ {print $1}')
	if [[ ${#files[@]} != 0 ]]; then
		for i in "${files[@]}"; do
			echo "$i" >>/tmp/lvim-shell
		done
		is_break=true
	fi
	for i in "${selected[@]}"; do
		echo "$i" >>/tmp/lvim-shell_qf
	done
}

while :; do
	action=$(cat /tmp/lvim-file-manager/action)
	separator=("--separator=")
	header=("--header=")
	info=("--inline-info")
	no_border=("--no-border")
	border=("--border=none")
	pointer=("--pointer=")
	marker=("--marker=")
	multi=("-m")
	sort=("-s")
	tac=()
	delimiter=()
	long_info=""
	show_hidden_files=""
	preview_window_hidden=()
	preview_window=("--preview-window=right:50%:noborder")
	on_change="--bind=change:top"
	preview_window_for_search_in_files=()
	enter=("--bind=enter:accept")
	bind_base=(
		"--bind=esc:clear-selection+execute(echo QUIT)+abort"
		"--bind=ctrl-c:clear-selection+clear-query"
		"--bind=ctrl-d:preview-down,ctrl-u:preview-up,ctrl-b:preview-half-page-up,ctrl-f:preview-half-page-down"
		"--bind=alt-p:toggle-preview+execute( \
            touch /tmp/lvim-file-manager/prevent && \
            [ ! -f /tmp/lvim-file-manager/hidden-preview ] \
            && touch /tmp/lvim-file-manager/hidden-preview \
            || rm /tmp/lvim-file-manager/hidden-preview)"
		"--bind=alt-,:abort+clear-selection+execute-silent( \
            touch /tmp/lvim-file-manager/prevent && \
            echo $PWD > /tmp/lvim-file-manager/pwd \
            )+top+accept"
		"--bind=alt-.:abort+clear-selection+execute-silent( \
            touch /tmp/lvim-file-manager/prevent && \
            touch /tmp/lvim-file-manager/reload && \
            rm /tmp/lvim-file-manager/pwd \
            )+top+accept"
		"--bind=alt-m:abort+clear-selection+execute-silent( \
            touch /tmp/lvim-file-manager/prevent && \
            echo menu > /tmp/lvim-file-manager/action \
            )+top+accept"
		"--bind=alt-e:abort+clear-selection+execute-silent( \
            touch /tmp/lvim-file-manager/prevent && \
            echo explorer > /tmp/lvim-file-manager/action \
            )+top+accept"
		"--bind=alt-a:abort+clear-selection+execute-silent( \
            touch /tmp/lvim-file-manager/prevent && \
            echo search-directories-and-files > /tmp/lvim-file-manager/action \
            )+top+accept"
		"--bind=alt-d:abort+clear-selection+execute-silent( \
            touch /tmp/lvim-file-manager/prevent && \
            echo search-directories > /tmp/lvim-file-manager/action \
            )+top+accept"
		"--bind=alt-f:abort+clear-selection+execute-silent( \
            touch /tmp/lvim-file-manager/prevent && \
            echo search-files > /tmp/lvim-file-manager/action \
            )+top+accept"
		"--bind=alt-w:abort+clear-selection+execute-silent( \
            touch /tmp/lvim-file-manager/prevent && \
            echo search-in-files > /tmp/lvim-file-manager/action \
            )+top+accept"
	)
	bind_group=()
	bind_app=()
	preview_engine=("--preview=VAL={..}; [ -f {2} -o -d {2} ] && VAL={2}; test -f \$VAL; [ -f {9} -o -d {9} ] && VAL={9}; test -f \$VAL && \
        {
            file -biz \$PWD/\$VAL | grep ^text &>/dev/null && {
            echo \$PWD/\$VAL | xargs bat --color=always --decorations=never;
            }
        }  \
        || \
        { \
            [ \$VAL != \$PWD ] && exa \
            $show_hidden_files \
            --group \
            --oneline \
            --git-ignore \
            --git \
            --ignore-glob '.cache|.git|.vendor|node_modules|buffers' \
            --colour=always \
            --icons \
            --group-directories-first \
            --classify \
            --level 1 \
            \$VAL 2>/dev/null
        }"
	)
	if [[ -f /tmp/lvim-file-manager/hidden-preview ]]; then
		preview_window_hidden=("--preview-window=:hidden")
	fi
	if [[ $action == "menu" ]]; then
		header=("--header= MENU")
		prompt=("--prompt=  Choice  ")
		preview_window_hidden=("--preview-window=:hidden")
	elif [[ $action == "explorer" ]]; then
		header=("--header=󰙅 EXPLORER  $PWD")
		prompt=("--prompt=  Browse  ")
		bind_app=(
			"--bind=alt-l:clear-selection+execute-silent( \
                touch /tmp/lvim-file-manager/prevent && \
                [ ! -f /tmp/lvim-file-manager/long-info ] \
                && touch /tmp/lvim-file-manager/long-info \
                || rm /tmp/lvim-file-manager/long-info \
                )+top+accept"
			"--bind=alt-h:clear-selection+execute-silent(\
                touch /tmp/lvim-file-manager/prevent && \
                [ ! -f /tmp/lvim-file-manager/hidden-files ] \
                && touch /tmp/lvim-file-manager/hidden-files \
                || rm /tmp/lvim-file-manager/hidden-files \
                )+top+accept"
		)
		if [[ -f /tmp/lvim-file-manager/hidden-files ]]; then
			show_hidden_files="-a"
		fi
		if [[ -f /tmp/lvim-file-manager/long-info ]]; then
			long_info="--long"
		fi
	elif [[ $action == "search-directories-and-files" ]]; then
		header=("--header=󱋣 SEARCH DIRECTORIES AND FILES  $PWD")
		prompt=("--prompt=  Search  ")
		bind_app=(
			"--bind=alt-h:clear-selection+execute-silent(\
                touch /tmp/lvim-file-manager/prevent && \
                [ ! -f /tmp/lvim-file-manager/hidden-files ] \
                && touch /tmp/lvim-file-manager/hidden-files \
                || rm /tmp/lvim-file-manager/hidden-files \
                )+top+accept"
		)
	elif [[ $action == "search-directories" ]]; then
		header=("--header=󰉋 SEARCH DIRECTORIES  $PWD")
		prompt=("--prompt=  Search  ")
		bind_app=(
			"--bind=alt-h:clear-selection+execute-silent(\
                touch /tmp/lvim-file-manager/prevent && \
                [ ! -f /tmp/lvim-file-manager/hidden-files ] \
                && touch /tmp/lvim-file-manager/hidden-files \
                || rm /tmp/lvim-file-manager/hidden-files \
                )+top+accept"
		)
	elif [[ $action == "search-files" ]]; then
		header=("--header=󰈔 SEARCH FILES  $PWD")
		prompt=("--prompt=  Search  ")
		bind_app=(
			"--bind=alt-h:clear-selection+execute-silent(\
                touch /tmp/lvim-file-manager/prevent && \
                [ ! -f /tmp/lvim-file-manager/hidden-files ] \
                && touch /tmp/lvim-file-manager/hidden-files \
                || rm /tmp/lvim-file-manager/hidden-files \
                )+top+accept"
		)
	elif [[ $action == "search-in-files" ]]; then
		header=("--header=󰈙 SEARCH IN FILES  $PWD")
		prompt=("--prompt=  Search  ")
		bind_app=(
			"--bind=alt-h:clear-selection+execute-silent(\
                touch /tmp/lvim-file-manager/prevent && \
                [ ! -f /tmp/lvim-file-manager/hidden-files ] \
                && touch /tmp/lvim-file-manager/hidden-files \
                || rm /tmp/lvim-file-manager/hidden-files \
                )+top+accept"
		)
		preview_window_for_search_in_files=("--preview-window=~0,+{2}+1/2")
		delimiter=("--delimiter=:")
		preview_engine=("--preview=VAL={1} && \
        {
            file -biz \$PWD/\$VAL | grep ^text &>/dev/null && {
                bat --color=always --style=numbers -H {2} {1}
            }
        } \
        || \
        { \
            [ \$VAL != \$PWD ] && exa \
            $show_hidden_files \
            --group \
            --oneline \
            --git-ignore \
            --git \
            --ignore-glob '.cache|.git|.vendor|node_modules|buffers' \
            --colour=always \
            --icons \
            --group-directories-first \
            --classify \
            --level 1 \
            \$VAL 2>/dev/null
        }"
		)
	fi
	selected=$(
		get_list_for_fzf "$@" |
			IFS=$'\n' fzf \
				--query="$1" \
				--nth="$(get_column_to_search)" \
				"${delimiter[@]}" \
				"${separator[@]}" \
				"${prompt[@]}" \
				"${header[@]}" \
				--header-first \
				"${info[@]}" \
				"${no_border[@]}" \
				"${border[@]}" \
				"${pointer[@]}" \
				"${marker[@]}" \
				"${multi[@]}" \
				"${sort[@]}" \
				"${tac[@]}" \
				"${preview_engine[@]}" \
				"${preview_window[@]}" \
				"${preview_window_for_search_in_files[@]}" \
				"${preview_window_hidden[@]}" \
				"${on_change[@]}" \
				"${bind_base[@]}" \
				"${bind_group[@]}" \
				"${bind_app[@]}" \
				"${enter[@]}"
	)
	if [[ $selected == "QUIT" ]]; then
		break
	elif [[ $action == "menu" ]]; then
		choice=$(
			echo "$selected" | cut -d" " -f2-
		)
		case "$choice" in
		"EXPLORER")
			echo "explorer" >/tmp/lvim-file-manager/action
			;;
		"SEARCH FILES")
			echo "search-files" >/tmp/lvim-file-manager/action
			;;
		"SEARCH IN FILES")
			echo "search-in-files" >/tmp/lvim-file-manager/action
			;;
		esac
		return
	elif [[ $action == "search-in-files" ]]; then
		if [[ -f /tmp/lvim-file-manager/prevent ]]; then
			rm /tmp/lvim-file-manager/prevent
			if [[ -f /tmp/lvim-file-manager/reload ]]; then
				rm /tmp/lvim-file-manager/reload
				builtin cd "$(cat /tmp/lvim-file-manager/base-directory)" || return
			fi
		else
			if [[ $selected == " .." ]]; then
				builtin cd .. || return
			fi
			post_action_search
			if [[ $is_break == true ]]; then
				break
			fi
		fi
	elif [[ $action == "search-directories-and-files" ]] || [[ $action == "search-directories" ]] || [[ $action == "search-files" ]]; then
		if [[ -f /tmp/lvim-file-manager/prevent ]]; then
			rm /tmp/lvim-file-manager/prevent
			if [[ -f /tmp/lvim-file-manager/reload ]]; then
				rm /tmp/lvim-file-manager/reload
				builtin cd "$(cat /tmp/lvim-file-manager/base-directory)" || return
			fi
		else
			result=$(
				echo "$selected" |
					rev |
					cut -f1 -d ' ' |
					rev |
					sed \
						-e 's/\[[0-9];[0-9][0-9]m//g' \
						-e 's/\[[0-9];[0-9];[0-9][0-9]m//g' \
						-e 's/\[0m//g' \
						-e 's/ //g'
			)
			post_action
			if [[ $is_break == true ]]; then
				break
			fi
		fi
	elif [[ $action == "explorer" ]]; then
		if [[ -f /tmp/lvim-file-manager/prevent ]]; then
			rm /tmp/lvim-file-manager/prevent
			if [[ -f /tmp/lvim-file-manager/reload ]]; then
				rm /tmp/lvim-file-manager/reload
				builtin cd "$(cat /tmp/lvim-file-manager/base-directory)" || return
			fi
		else
			result=$(
				echo "$selected" |
					rev |
					cut -f1 -d ' ' |
					rev |
					sed \
						-e 's/\[[0-9];[0-9][0-9]m//g' \
						-e 's/\[[0-9];[0-9];[0-9][0-9]m//g' \
						-e 's/\[0m//g' \
						-e 's/ //g'
			)
			is_explorer=true
			post_action
			if [[ $is_break == true ]]; then
				break
			fi
		fi
	fi
done

# vi: ft=sh
